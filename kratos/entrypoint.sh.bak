#!/bin/bash

# This is the entrypoint file, we will Verfify multiple steps that if already done will be omitted
# Then we'll start the Kratos server

# Check if Envirnoment variables are set
# If not, fail with an echo message

if [ -z "$POSTGRES_HOST" ]; then
	echo "POSTGRES_HOST is not set"
	exit 1
fi
if [ -z "$POSTGRES_PORT" ]; then
	echo "POSTGRES_PORT is not set"
	exit 1
fi
if [ -z "$POSTGRES_USER" ]; then
	echo "POSTGRES_USER is not set"
	exit 1
fi
if [ -z "$POSTGRES_PASSWORD" ]; then
	echo "POSTGRES_PASSWORD is not set"
	exit 1
fi
if [ -z "$POSTGRES_DBNAME" ]; then
	echo "POSTGRES_DBNAME is not set"
	exit 1
fi

echo "All environment variables are set, Starting..."

# Check if postgres is up and running
# If not, fail

POSTGRES_UP= eval "pg_isready -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER"

if [ $POSTGRES_UP -ne 0 ]; then
	echo "Postgres is not up and running"
	exit 1
fi

# Check if the database is already created (kratos)
# If not, create it

DATABASE_EXISTS= eval "psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -d $POSTGRES_DBNAME -c '\l' | grep $POSTGRES_DBNAME"

if [ $DATABASE_EXISTS -ne 0 ]; then
	echo "Database $POSTGRES_DBNAME does not exist, creating it"
	psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -d $POSTGRES_DBNAME -c "CREATE DATABASE $POSTGRES_DBNAME"
fi

# Check that the database encryption is scram-sha-256

PASSWD_ENCRYPTION= eval "psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -d $POSTGRES_DBNAME -c 'SHOW password_encryption' | grep scram-sha-256"

if [ $PASSWD_ENCRYPTION -ne 0 ]; then
	echo "Database encryption is not scram-sha-256, changing it"
	psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -d $POSTGRES_DBNAME -c "ALTER DATABASE $POSTGRES_DBNAME SET password_encryption = 'scram-sha-256'"
	psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -d $POSTGRES_DBNAME -c "SELECT pg_reload_conf()"
fi

# Set Kratos config to valid postgres connection
sed -i 's|dsn: memory|dsn: postgres://"$POSTGRES_USER":"$POSTGRES_PASSWORD"@"$POSTGRES_HOST":"$POSTGRES_PORT"/"$POSTGRES_DBNAME"?sslmode=disable|g' /home/kratos/config/kratos.yml

# Apply migrations

/home/kratos/bin/kratos -c /home/kratos/config/kratos.yml migrate sql -y postgres://"$POSTGRES_USER":"$POSTGRES_PASSWORD"@"$POSTGRES_HOST":"$POSTGRES_PORT"/"$POSTGRES_DBNAME"?sslmode=disable

# Start Kratos
exec "$@"